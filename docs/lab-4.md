<div id="rdpGuide" role="tabpanel" class="tab-pane markdown-output active"><h1>HOL1142: Optimizing HTTPS (SSL) Traffic with SteelHead</h1> <h3>Introduction</h3> <h4>Overview</h4> <p>SSL provides a way for client and server applications to communicate securely over a potentially insecure network. It provides authentication and prevents eavesdropping and tampering. In the most common use case, we use SSL to transport HTTP traffic and provide one-way identification: only the web server authenticates itself to the web browser.</p> <p>In response to the Hello message, the server sends back its certificate. The certificate contains the server's public key, some identifying information about the server (such as its name and location), and a digital signature of all this information. This digital signature is issued by an entity called a Certificate Authority (CA) that both the client and the server trust, and it serves as proof that no one has tampered with the certificate.</p> <p>Upon receiving the certificate, the client verifies that it has not been tampered with and that it does belong to that particular server. Then, the client generates a random number N, encrypts it with the server's public key, and sends it to the server. At this point, both the client and the server use the same function to derive the session key, ks, from N. In the simplest case, after the initial SSL handshake between the client and the server and the creation of the session keys, the same session keys are used for the duration of the session, without the need to go through another SSL handshake.</p> <h4>Use Case</h4> <p>As more and more applications are using HTTPS, though you may have CIFS &amp; HTTP optimization enabled and working spendidly, much of your traffic may not be optimized since it is HTTPS (SSL). So let's get that SSL optimized!</p> <h4>Solution</h4> <p>At a high level, SteelHeads terminate an optimized SSL connection by making the client think it is communicating to the server and making the server think it is talking to the client. In fact, the client and server are talking securely to the SteelHeads. You require some special provisioning to accomplish optimization that appears transparent to the client.</p> <p>To enable SSL connection termination, you must configure the server-side SteelHead to include digital certificates and private keys in order to emulate the servers. When the SteelHead poses as the server, there does not need to be any change to either the client or the server. The security model is not compromised — the optimized SSL connection continues to guarantee server-side authentication and prevents eavesdropping and tampering.</p> <p>When transferring data over the WAN on behalf of an optimized SSL connection, the client-side and server-side SteelHeads ensure that their inner connection provides all the security features the original SSL connection would have, had it not been optimized. SteelHeads accomplish this by establishing their own SSL connection between themselves. To secure the inner SteelHead channel, you must configure each SteelHead to trust the certificate of the peer SteelHead (secure peering); there are various methods to accomplish this.</p> <h4>Lab Objectives</h4> <ul><li>Ensure required DNS and Connect to the Branch SteelHead Web UI (Web UI).</li> <li>Configure a CA and certificate and install on client and server.</li> <li>Verify SSL License on Branch SteelHead</li> <li>Enable SSL Optimization on Branch SteelHead</li> <li>Connect to the Datacenter SteelHead Web UI (Web UI)</li> <li>Verify SSL License on Datacenter SteelHead</li> <li>Enable SSL Optimization on Datacenter SteelHead</li> <li>Import Web Server SSL Certificates into Datacenter SteelHead</li> <li>Import CA Certificate into Datacenter SteelHead</li> <li>Configure SteelHead Peering Trust</li> <li>Create an In-Path Rule for SSL Traffic to N31-FIL Web Server</li> <li>Verify SSL Optimization</li> <li>Troubleshoot SSL Connection</li> <li>Reconfigure to use a proxy certificate</li></ul> <hr> <h3>Task 1. Ensure required DNS and Connect to the Branch SteelHead Web UI (Web UI)</h3> <h4>Objective</h4> <p>In this task, you will ensure n21-pc can resolve the common name (CN) for the SSL server; a critical step for secure browsing to SSL-secured web sites. In production networks, name resolution is usually performed by DNS services, but it is useful to know how to point hosts to specific hostnames in the event DNS is not configured for a given host.</p> <p>Lastly, you will log into the 'branch' SteelHead, <code>n120-sh1</code>, to prepare for subsequent configuration.</p> <h4>Detailed Steps</h4> <ul><li><p>First, we add the <code>n31-fil</code> name, FQDN, and IP address to the <code>n21-pc</code> hosts file.  On the n21-pc, click the <strong>Start</strong> button and then type <em>Notepad</em>. Right-click and then select <strong>Run as Administrator</strong>:</p> <p><img src="https://edu-screenshots.s3.amazonaws.com/current/a4e0751f-75c4-4f96-8909-0c6592b226c0.png" alt="screenshot" title="open Notepad as administrator"></p></li> <li><p>Open the <em>hosts</em> file, located in <code>C:\Windows\System32\drivers\etc</code>.  In this folder you will need to change the view from "Text Documents (*.txt)" to <strong>All Files (*.*)</strong> in Notepad in order to see it:</p> <p><img src="https://edu-screenshots.s3.amazonaws.com/current/ee91fcbf-9631-4e56-a499-6b90b2580f54.png" alt="screenshot" title="Notepad &amp; hosts file"></p></li> <li><p>Add the following line to the end of the file:</p> <pre><code>10.1.31.130   n31-fil   n31-fil.cyberdyne.corp</code></pre></li> <li><p>Save the file and close Notepad.</p></li> <li><p>Next, open Chrome or Firefox and use the bookmarks toolbar to navigate to <strong>Branch Optimization &gt; n120-sh1 SteelHead 1 (Path 1)</strong>.</p></li> <li><p>When presented with the login screen, use the username <code>admin</code> and password <code>password</code>.</p></li> <li><p>You will be directed to the SteelHead dashboard.</p> <p><img src="https://edu-screenshots.s3.amazonaws.com/current/bdfb2d68-a032-4640-a794-540022b30901.png" alt="screenshot" title="Screenshot"></p></li></ul> <h4>Review</h4> <p>You have ensured required domain names can be resolved on n21-PC, and accessed the user interface of the client-side SteelHead.</p> <hr> <h3>Task 2. Create and configure your own Certificate Authority (CA) in Linux</h3> <h4>Objective</h4> <p>In this task we will create a Certificate Authority (CA) in Linux using OpenSSL.  Once we have done this we will use our new CA to digitally sign an SSL certificate for our web-server.  We can then import our CA certificate into our browser so it trusts SSL certificates signed by the CA.</p> <h4>Detailed Steps</h4> <ul><li><p>Using your Windows client PC, open <strong>mRemoteNG</strong>.</p></li> <li><p>In the sidebar, double click on <strong>Datacenter - Tier 3 - Hosts &gt; N31-FIL File Server</strong> to open an SSH connection to the server.</p></li> <li><p>Click inside of the black console window to activate the SSH session. You will need to select <strong>YES</strong> to accept the risk of using a self-signed certificate with SSH.</p></li> <li><p>Login using the username <code>root</code> and password <code>myeLab!</code>.</p></li> <li><p>Create a new CA certificate using the following command:</p> <pre><code>openssl req -x509 -nodes -newkey rsa:2048 -keyout ca.key -out ca.cer -days 1095</code></pre></li> <li><p>At the resulting prompts, fill in your CA details as follows:</p> <pre><code>Country Name (2 letter code) [AU]: US
State or Province Name (full name) [Some-State]: California
Locality Name (eg, city) []: San Francisco
Organization Name (eg, company) [Internet Widgits Pty Ltd]: Riverbedlab
Organizational Unit Name (eg, section) []: Training
Common Name (e.g. server FQDN or YOUR name) []: zaphod.cyberdyne.corp
Email Address []: ford@cyberdyne.corp</code></pre></li> <li><p>Type <code>ls</code>; you should see some files.  The ones we are interested in are <code>ca.cer</code> and <code>ca.key</code>.  There should be a couple of other certificate files in the directory but you can safely ignore them.</p></li> <li><p>We now have a CA which we can use to sign certificates.  We will now use this to sign the certificate for our server (n31-fil).  To do this we will create a certificate signing request (CSR) and then sign this request with our newly generated CA key.  To create the CSR, start by typing the following command:</p> <pre><code>openssl req -newkey rsa:2048 -nodes -keyout n31-fil.key -out n31-fil.csr</code></pre></li> <li><p>At the resulting prompts, fill in the details for your new certificate:</p> <pre><code>Country Name (2 letter code) [AU]: US
State or Province Name (full name) [Some-State]: California
Locality Name (eg, city) []: San Francisco
Organization Name (eg, company) [Internet Widgits Pty Ltd]: Riverbedlab
Organizational Unit Name (eg, section) []: Training
Common Name (e.g. server FQDN or YOUR name) []: n31-fil.cyberdyne.corp
Email Address []: ford@cyberdyne.corp

A challenge password []: &lt;just press enter&gt;
An optional company name []: &lt;just press enter&gt;</code></pre> <blockquote><p>The key field here is the Common Name (CN).  This <em>must</em> match what is typed in on the browser window or it will simply not work.  Name resolution is essential for SSL.</p></blockquote></li> <li><p>Sign the request using your CA key:</p> <pre><code>openssl x509 -req -days 1095 -in n31-fil.csr -CA ca.cer -CAkey ca.key -CAcreateserial -out n31-fil.cer</code></pre> <p><img src="https://s3.amazonaws.com/edu-screenshots/legacy/114220170119062325.png" alt="screenshot" title="Screenshot"></p></li> <li><p>We now need to configure Apache to use this newly signed certificate.  Fortunately, the server you are currently connected to is also our web server so this step is pretty straightforward. Type the following commands to place the certificate and key into the appropriate directories:</p> <pre><code>cp n31-fil.cer /etc/ssl/certs
cp n31-fil.key /etc/ssl/private</code></pre></li> <li><p>We now need to edit the SSL configuration file within Apache to point to these new certificates.  This requires some manual editing of the <em>default-ssl</em> configuration file. We are going to use the <strong>nano</strong> text editor as it is simple, but feel free to use <strong>vi</strong> if you prefer.</p> <pre><code>nano /etc/apache2/sites-enabled/default-ssl</code></pre></li> <li><p>Within nano, search (or scroll down) for the two lines which contain the paths to the certificate files:</p> <pre><code>SSLCertificateFile      /etc/ssl/certs/ssl-cert-snakeoil.pem
SSLCertificateKeyFile   /etc/ssl/private/ssl-cert-snakeoil.key</code></pre></li> <li><p>Change these lines to the following:</p> <pre><code>SSLCertificateFile      /etc/ssl/certs/n31-fil.cer
SSLCertificateKeyFile   /etc/ssl/private/n31-fil.key</code></pre></li> <li><p>Hit <code>ctrl+o</code> keys, then 'Enter' to save the changes, and then <code>ctrl+x</code> to exit.</p></li> <li><p>You will next add the ServerName variable for correct virtual host resolution.</p> <pre><code>nano /etc/apache2/conf.d/fqdn</code></pre></li> <li><p>Add the following line to the empty file.</p> <pre><code>ServerName n31-fil.cyberdyne.corp</code></pre></li> <li><p>Hit <code>ctrl+o</code> keys, then 'Enter' to save the changes, and then <code>ctrl+x</code> to exit.</p></li> <li><p>Finally, restart the Apache service to use the new configuration.</p> <pre><code>service apache2 restart</code></pre> <blockquote><p>Good to note any errors here, though a warning about <em>NameVirtualHost</em> should not cause problems in our scenario.</p></blockquote></li> <li><p>Minimize your SSH client and then, via the Start Menu, click on <strong>FileZilla</strong>.  In the menu bar enter the following information and then click on <strong>QuickConnect</strong>:</p> <pre><code>Host: 10.99.31.130
Username: root
Password: myeLab!
Port: 22</code></pre></li> <li><p>In the <em>Filename</em> box on the <em>Remote Site</em> scroll down and drag the following files to the Desktop on the <em>Local Site</em>:</p> <pre><code>ca.cer
n31-fil.cer
n31-fil.key</code></pre> <p><img src="https://edu-screenshots.s3.amazonaws.com/current/64906823-88ec-4311-8190-e124d4b1cdd5.png" alt="screenshot" title="Filezilla Certificate Transfer"></p></li> <li><p>Minimize FileZilla and then return to Firefox.  Click the hamburger button on the top right of the Firefox window to bring up the menu:</p> <p><img src="https://edu-screenshots.s3.amazonaws.com/current/2e56ba7c-7f8f-41a3-9a80-96252d2c763c.png" alt="screenshot" title="Screenshot"></p></li> <li><p>Click <strong>Options</strong> and then <strong>Privacy and Security</strong> on the menu on the left. Scroll to the bottom to the Certificates section.</p> <p><img src="https://edu-screenshots.s3.amazonaws.com/current/dba49f2f-ebb0-4704-9db2-3e4c862ec374.png" alt="screenshot" title="Screenshot"></p></li> <li><p>Click on <strong>View Certificates</strong> and in the resulting window select the <em>Authorities</em> tab as shown:</p> <p><img src="https://edu-screenshots.s3.amazonaws.com/current/129dd6ea-7b6b-45f0-8d3a-b16f3c6e13df.png" alt="screenshot" title="Screenshot"></p></li> <li><p>Click <strong>Import</strong> at the bottom (may need to scroll down) and then select the <code>ca.cer</code> file on the Desktop. Click <strong>Open</strong>.</p></li> <li><p>At the resulting window click the box next to <em>Trust this CA to identify websites</em>:</p> <p><img src="https://edu-screenshots.s3.amazonaws.com/current/de40b352-c0af-4ec3-9e66-8e6e1df993a7.png" alt="screenshot" title="Screenshot"></p></li> <li><p>Click <strong>OK</strong>. If you scroll down in the <em>Authorities</em> window you should be able to see the <em>Riverbedlab</em> certificate which you just a short while ago created:</p> <p><img src="https://edu-screenshots.s3.amazonaws.com/current/511a3e8c-370d-456d-9121-bb524a050324.png" alt="screenshot" title="Screenshot"></p></li> <li><p>Finally, open a new tab in Firefox and type the following URL:</p> <p><a href="https://n31-fil.cyberdyne.corp">https://n31-fil.cyberdyne.corp</a></p> <blockquote><p>The page should load without any errors and the little padlock should be closed and gray. Click on it.</p></blockquote> <p><img src="https://edu-screenshots.s3.amazonaws.com/current/d3109dc8-9784-4967-9c17-7bf931ade1da.png" alt="screenshot" title="Secure SSL to n31-fil"></p> <blockquote><p>With recent versions of Firefox, a gray padlock indicates that you're definitely connected to the website whose address is shown in the address bar, and the connection between Firefox and the website is encrypted. What it also indicates is that the site is not using a (more expensive) Extended Validation SSL certificate, which is now what Firefox's green padlock is reserved for.</p></blockquote></li> <li><p>Click on the arrow and then <em>More information</em>.  You should see the following:</p> <p><img src="https://s3.amazonaws.com/edu-screenshots/legacy/114220170119071728.png" alt="screenshot" title="Screenshot"></p></li> <li><p>Click <strong>View Certificate</strong>.  You should finally see the following:</p> <p><img src="https://s3.amazonaws.com/edu-screenshots/legacy/114220170119071828.png" alt="screenshot" title="Screenshot"></p></li></ul> <h4>Review</h4> <p>In this in-depth task, we have setup a Linux server as a certificate authority, and then used this to sign a certificate for our web server.  We then reconfigured our web server to use this signed certificate and then imported the CA certificate into our browser.  The result is that our website is now trusted via it's certificate signed by a trusted CA.  All of this will be important for later steps when we configure our SteelHeads to optimize the SSL traffic to/from this server.  The principles we have implemented here will be put to good use in the later tasks.  <strong>Do not delete the certificate files you have stored on your desktop - you will need them for later tasks.</strong></p> <hr> <h3>Task 3. Verify SSL License on Branch SteelHead</h3> <h4>Objective</h4> <p>In this task, you will <strong>verify</strong> the Enhanced Cryptographic License Key is valid on the branch SteelHead appliance.</p> <blockquote><p>The SSL License is called the Enhanced Cryptographic License Key, because it also activates RiOS data store encryption and can create secure inner channels while optimizing encrypted MAPI and SMB-signed traffic (even if the SteelHeads aren’t configured for optimizing user SSL traffic).</p></blockquote> <h4>Detailed Steps</h4> <ul><li><p>Using the <strong>N120-SH1</strong> Branch SteelHead Web UI, navigate to <strong>Administration &gt; Maintenance &gt; Licenses</strong>.</p></li> <li><p>Locate the <strong>Enhanced Cryptographic License Key</strong> in the list.</p></li> <li><p>Under the <strong>Status</strong> column, verify the license key is <strong>Valid</strong>.</p> <p><img src="https://s3.amazonaws.com/edu-screenshots/legacy/114220161215015200.png" alt="screenshot" title="Screenshot"></p> <blockquote><p>No action is required, it is best practice to visually check these keys are valid prior to configuring SSL.</p></blockquote></li></ul> <h4>Review</h4> <p>If you don’t have a valid Enhanced Cryptography License Key, visit <a href="https://sslcert.riverbed.com">https://sslcert.riverbed.com</a> and follow the instructions.</p> <hr> <h3>Task 4. Enable SSL Optimization on Branch SteelHead</h3> <h4>Objective</h4> <p>In this task, you will enable SSL optimization on the branch SteelHead.</p> <blockquote><p>The SteelHead can securely decrypt, optimize, and then reencrypt SSL traffic. To configure SSL support, you are not required to make configuration changes on the client or server hosts; clients continue connecting to the same server name or IP address.</p></blockquote> <h4>Detailed Steps</h4> <ul><li><p>Using the <strong>N120-SH1</strong> Web UI, navigate to <strong>Optimization &gt; SSL &gt; SSL Main Settings</strong></p></li> <li><p>Check the <strong>Enable SSL Optimization</strong> checkbox and click the <strong>Apply</strong> button.</p></li> <li><p>In the top right, click the <strong>Save to Disk</strong> button to write your change to NVRAM.</p> <p><img src="https://s3.amazonaws.com/edu-screenshots/legacy/112120170407125432.png" alt="screenshot" title="Screenshot"></p></li> <li><p>Restart the optimization service.</p> <blockquote><p>Remember that in a production environment the optimization service should only be restarted during a change window, as all connections currently optimized by that SteelHead would be disrupted.</p></blockquote></li></ul> <h4>Review</h4> <p>SSL must be enabled on both the client-side and server-side SteelHeads for SSL optimization to work. In the upcoming tasks we will enable SSL on the server-side SteelHead.</p> <hr> <h3>Task 5. Connect to the Datacenter SteelHead Web UI (Web UI)</h3> <h4>Objective</h4> <p>In this task, you will login to access the <strong>Datacenter SteelHead</strong> appliance using the username <code>admin</code> and password <code>password</code>.</p> <h4>Detailed Steps</h4> <ul><li><p>Open a <strong>new tab</strong> in Firefox.</p></li> <li><p>Use the bookmarks toolbar to navigate to <strong>Datacenter Optimization &gt; n130-sh1 SteelHead 1 (Path 1)</strong>.</p></li> <li><p>When presented with the login screen, use the username <code>admin</code> and password <code>password</code>.</p></li> <li><p>You will be directed to the N130-SH1 SteelHead dashboard.</p> <p><img src="https://edu-screenshots.s3.amazonaws.com/current/08d91d0b-7f1e-43f2-a79d-a5aed47cf1bb.png" alt="screenshot" title="Screenshot"></p></li></ul> <h4>Review</h4> <p>You have <strong>logged in</strong> to both the <strong>Branch</strong> and <strong>Datacenter SteelHead</strong> Web UIs, allowing you to configure the respective appliances by simply switching browser tabs.</p> <hr> <h3>Task 6. Verify SSL License on Datacenter SteelHead</h3> <h4>Objective</h4> <p>In this task, you will <strong>verify</strong> the Enhanced Cryptographic License Key is valid on the datacenter SteelHead appliance.</p> <h4>Detailed Steps</h4> <ul><li><p>Using the <strong>N130-SH1</strong> Datacenter SteelHead Web UI, navigate to <strong>Administration &gt; Maintenance &gt; Licenses</strong>.</p></li> <li><p>Locate the <strong>Enhanced Cryptographic License Key</strong> in the list.</p></li> <li><p>Under the <strong>Status</strong> column, verify the license key is <strong>Valid</strong>.</p> <blockquote><p>No action is required, it is best practice to visually check these keys are valid prior to configuring SSL.</p></blockquote></li></ul> <h4>Review</h4> <p>If you don’t have a valid Enhanced Cryptography License Key, visit <a href="https://sslcert.riverbed.com">https://sslcert.riverbed.com</a> and follow the instructions.</p> <hr> <h3>Task 7. Enable SSL Optimization on Datacenter SteelHead</h3> <h4>Objective</h4> <p>In this task, you will enable SSL optimization on the datacenter SteelHead.</p> <h4>Detailed Steps</h4> <ul><li><p>Using the <strong>N130-SH1</strong> Datacenter SteelHead Web UI, navigate to <strong>Optimization &gt; SSL &gt; SSL Main Settings</strong></p></li> <li><p>Check the <strong>Enable SSL Optimization</strong> checkbox and click the <strong>Apply</strong> button.</p></li> <li><p>In the top right, click the <strong>Save to Disk</strong> button to write your change to NVRAM.</p> <p><img src="https://s3.amazonaws.com/edu-screenshots/legacy/112120170407125646.png" alt="screenshot" title="Screenshot"></p></li> <li><p>Restart the optimization service.</p> <blockquote><p>Remember that in a production environment the optimization service should only be restarted during a change window, as all connections currently optimized by that SteelHead would be disrupted. With SSL enabled on both SteelHead client- and server-side appliances, you can configure the remaining tasks for SSL optimization without restarting the optimization service.</p></blockquote></li></ul> <h4>Review</h4> <p>You have successfully enabled SSL optimization on both the branch and datacenter SteelHead appliances.</p> <hr> <h3>Task 8. Import Web Server SSL Certificate and Key into Datacenter SteelHead</h3> <h4>Objective</h4> <p>In this task, you will import the SSL certificate and private key for <code>n31-fil.cyberdyne.corp</code> into the datacenter SteelHead.</p> <h4>Detailed Steps</h4> <ul><li><p>Using the N130-SH1 Datacenter SteelHead Web UI, navigate to Optimization &gt; SSL &gt; SSL Main Settings.</p></li> <li><p>Scroll down to the <strong>SSL Server Certificates</strong> section and click <strong>Add a New SSL Certificate</strong>.</p></li> <li><p>In the <strong>Name</strong> field, type in <code>n31-fil</code>.</p></li> <li><p>Leave the <code>Import Certificate and Private Key</code> option selected and scroll down.</p></li> <li><p>In the <strong>Certificate</strong> section, select the <code>Upload (PKCS-12, PEM or DER formats)</code> option.</p></li> <li><p>Click the <strong>Browse</strong> button, navigate to the <em>n31-fil.cer</em> file you downloaded earlier and click <strong>Open</strong>.</p></li> <li><p>Scroll further down the screen to the <strong>Separate Private Key</strong> field. Under <em>Upload (PEM or DER formats)</em> click <strong>Browse...</strong> and now select the <em>n31-fil.key</em> file.</p></li> <li><p>Scroll slightly further down and click the <strong>Add</strong> button to save the certificate to the SteelHead.</p></li> <li><p>Though the import was successful, and sufficient for our scenario, it's worth reading the warning at the top of the window which sheds more light on the certificate trust process:</p></li></ul> <p><img src="https://s3.amazonaws.com/edu-screenshots/legacy/114220170119105137.png" alt="screenshot" title="Screenshot"></p> <h4>Review</h4> <p>You have successfully imported the web server's SSL Certificate and Key into the datacenter SteelHead.</p> <hr> <h3>Task 9. Import CA Certificate into Datacenter SteelHead</h3> <h4>Objective</h4> <p>Remember that the server-side SteelHead acts as a client to the SSL server.  For this to work, the SteelHead must trust the backend server (which for us is the web-server <strong>n31-fil</strong>).  This means that our server-side SteelHead has to be able to verify the web-server's certificate.  In order to do this we will to import the CA certifcate that signed the web server's certificate, into the server-side SteelHeads <em>Certificate Authorities</em> list.</p> <h4>Detailed Steps</h4> <ul><li><p>Remaining within the N130-SH1 GUI, navigate to <em>Optimization &gt; SSL &gt; Certificate Authorities</em>.</p></li> <li><p>Click <em>Add a New Certificate Authority</em>.</p> <blockquote><p>If desired, add a Local Name such as <strong>n31-fil_CA</strong>; makes the displayed CA Name much easier to identify than the long number string such as you'll note in the screenshot below.</p></blockquote></li> <li><p>Select the <em>Local File</em> option and click <strong>Browse</strong>.</p></li> <li><p>Navigate to the <em>ca.cer</em> file and click <strong>Open</strong>.</p></li> <li><p>Click <strong>Add</strong></p></li> <li><p>Scroll down the list, you should see an entry similar to the following:</p> <blockquote><p>Note that the certificates are displayed in alpha-numeric order, so if you added a Local Name then it will be sorted accordingly.</p></blockquote></li></ul> <p><img src="https://s3.amazonaws.com/edu-screenshots/legacy/114220170119110038.png" alt="screenshot" title="Screenshot"></p> <h4>Review</h4> <p>You have now imported the CA certificate used to sign the certificate on the web-server.  This is for the same trust process as when we earlier imported ca.cer into Firefox: the <strong>n130-sh1</strong> SteelHead (just as the Firefox browser earlier) can now use this CA certificate to verify the identity of the <strong>n31-fil</strong> server.</p> <hr> <h3>Task 10. Configure SteelHead Peering Trust</h3> <h4>Objective</h4> <p>In this task, you will add a trusted peer certificate to both the <strong>Branch</strong> and <strong>Datacenter Steelheads</strong> to create a secure inner channel. <em>You will need to verify the expiration date of both certificates. If they have expired, ensure that you generate new ones before proceeding with the next steps!</em></p> <blockquote><p>We need to configure each SteelHead to trust its peer in order to establish a secure inner channel for secure peering. When your SteelHeads were first deployed, they self-generated an SSH key pair that can be used for secure peering. We will copy the public key for each SteelHead onto the other SteelHead's list of trusted peers. There are many ways to accomplish this secure peering relationship, and this admittedly is not the most scalable (SCC provides that), but it is perhaps the simplest in explaining the process.</p></blockquote> <h4>Detailed Steps</h4> <ul><li><p>Using the <strong>N120-SH1</strong> Branch SteelHead Web UI, navigate to <strong>Optimization &gt; SSL &gt; Secure Peering (SSL)</strong>, and in the <em>Certificate Details</em> box, check the <strong>Expires On:</strong> date in the Validity section.</p> <p><img src="https://edu-screenshots.s3.amazonaws.com/current/fba93623-afa2-4f22-a257-30c05cce0b43.png" alt="screenshot" title="SSL Cert Validity"></p></li> <li><p><strong>If the certificate is still valid you can proceed to Step 4.</strong> Otherwise, to replace the existing certificate with a new one, in the <strong>Certificate</strong> box click on the <strong>Replace</strong> tab. Then select "Generate Self-Signed Certificate and New Private Key", and enter the following in the details:</p> <pre><code>Common Name: n120-sh1
Organization Name: Riverbed Technology, Inc
Organization Unit: RiverbedLab
Locality: San Francisco
State: California
Country: US
Email Address: ford@cyberdyne.corp
Validity Period: 3650</code></pre> <p>Scroll down and click "Generate Certificate and Key".</p> <p><img src="https://edu-screenshots.s3.amazonaws.com/current/15887e94-b0e2-4baf-994b-158f33dfc340.png" alt="screenshot" title="Screenshot"></p></li> <li><p>Perform the same for <strong>N130-SH1</strong> using the following details:</p> <pre><code>Common Name: n130-sh1
Organization Name: Riverbed Technology, Inc
Organization Unit: RiverbedLab
Locality: San Francisco
State: California
Country: US
Email Address: ford@cyberdyne.corp
Validity Period: 3650</code></pre> <p><img src="https://edu-screenshots.s3.amazonaws.com/current/113ed95d-c870-4b2e-b332-e4eddb05f86b.png" alt="screenshot" title="Screenshot"></p></li> <li><p>On the <strong>N120-SH1</strong>, under <strong>Optimization &gt; SSL &gt; Secure Peering (SSL)</strong>, select the <strong>PEM</strong> tab.</p> <p>Copy the <strong>N120-SH1</strong> secure peering (SSL) certificate, including the <code>-----BEGIN CERTIFICATE-----</code> and <code>-----END CERTIFICATE-----</code> lines.</p> <p><img src="https://edu-screenshots.s3.amazonaws.com/current/835fd5c8-2d62-46db-99f2-82811ff5ae8c.png" alt="screenshot" title="SSL PEM copy"></p></li> <li><p>Going to the <strong>N130-SH1</strong> Datacenter Steelhead Web UI, navigate to <strong>Optimization &gt; SSL &gt; Secure Peering (SSL)</strong>.</p></li> <li><p>Slide down to the <strong>Peering Trust</strong> section, and click <strong>Add a New Trusted Entity</strong>.</p></li> <li><p>Select the <code>Trust New Certificate</code> radio button, and if desired add the optional name <code>n120-sh1</code>.</p></li> <li><p>Select <strong>Cert Text</strong> radio button, and paste the <strong>N120-SH1</strong> secure peering (SSL) certificate into the text
box.</p></li> <li><p>Click <strong>Add</strong> and you will see notification that the certificate has been added.</p></li> <li><p><strong>Repeat the steps above</strong> to copy the <strong>N130-SH1</strong> Datacenter SteelHead secure peering (SSL) certificate onto <strong>N120-SH1</strong> as a trusted peer. If you see the warning, "not yet active", (implying the date/time on a certificate is 'in the future' for the SteelHead you're adding it to; in essence: their system clocks are out of sync) ignore it for now.</p></li></ul> <h3>Review</h3> <p>You have successfully established a trusted peering relationship between the branch and datacenter SteelHead.</p> <hr> <h3>Task 11. Create an In-Path Rule for SSL Traffic to N31-FIL Web Server</h3> <h4>Objective</h4> <p>In this task you will configure the client-side SteelHead to attempt optimization of specific SSL traffic. To do this you will create an in-path rule on <strong>n120-sh1</strong>, instructing it to perform auto-discovery for tcp/443 traffic from the N21 San Francisco branch (<code>10.1.21.0/24</code>) to the N31-FIL web server (<code>10.1.31.130/32</code>).</p> <blockquote><p>SSL certificates must be configured on the datacenter SteelHead for each web server we want to optimize; by default a server-side SteelHead will pass through SSL traffic unless explictly destined for a known server's IP address that we have the SSL certificates for.</p></blockquote> <h4>Detailed Steps</h4> <ul><li><p>Using the <strong>N120-SH1</strong> Web UI, navigate to <strong>Optimization &gt; Network Services &gt; In-Path Rules</strong></p></li> <li><p>Click <strong>Add a New In-Path Rule</strong>, and enter the following settings:</p> <pre><code>Source Subnet:          10.1.21.0/24
Destination Subnet:     10.1.31.130/32
Port:                   443
Position:               Start</code></pre></li> <li><p>Click the <strong>Add</strong> button.</p> <blockquote><p>Recall that a default rule causes tcp/443 to be pass-through, so we need to add our rule <em>above</em> the 'Secure' pass-through rule.</p> <p>Note also that, because we are focusing on tcp/443 traffic, we do not need to tell the SteelHead to perform SSL pre-optimization - that is automatic; just as it automatically performs latency optimization HTTP for tcp/80, and CIFS for tcp/445.</p></blockquote> <p><img src="https://s3.amazonaws.com/edu-screenshots/legacy/114220180521011338.png" alt="screenshot" title="Screenshot"></p></li> <li><p>Save your configuration.</p></li></ul> <h4>Review</h4> <p>You have configured an in-path rule to explicitly allow HTTPS (tcp/443) traffic from the 10.1.21.0/24 network, destined for the N31-FIL web server (10.1.31.130), to be optimized.</p> <hr> <h3>Task 12. Verify SSL Optimization</h3> <h4>Objective</h4> <p>In this task, we will perform an HTTPS file transfer to see if the SSL connection is being optimized.</p> <blockquote><p>Keep in mind that HTTPS connections are foundationally akin to HTTP in that they can close very quickly (often within a few seconds), so you'll need to refresh the Current Connections report quickly to identify the connections.  Sometimes the Traffic Summary or Optimized Throughput Reports more readily show that SSL is being optimized.</p></blockquote> <h4>Detailed Steps</h4> <ul><li><p>Using the <strong>N130-SH1</strong> Datacenter SteelHead Web UI, navigate to <strong>Reports &gt; Networking &gt; Current Connections</strong>.</p></li> <li><p>In <strong>Firefox</strong>, open a new tab and navigate to <code>https://n31-fil.cyberdyne.corp</code>. Click the little gray padlock next to the URL.  As we have imported the actual certificate and key this should be identical to what you observed back in task 2.</p></li> <li><p>Navigate to the Presentations directory and find a rather large file, &gt;15MB or so, to download. Easiest method is to right-click the file and click "Save Link As...", accept the default <em>Downloads</em> directory and click <strong>Save</strong>.</p></li> <li><p>Using the <strong>N130-SH1</strong> Datacenter SteelHead Web UI, and click <strong>Update</strong> to refresh the list of connections.</p> <blockquote><p>If this is done quickly, you may be able to see the connection, however the connection will not display if it has already completed.</p></blockquote></li> <li><p>Navigate to <strong>Reports &gt; Networking &gt; Optimized Throughput</strong>, and for completeness you can filter the Port to <code>443 SSL</code></p> <p><img src="https://edu-screenshots.s3.amazonaws.com/current/62452ce2-159f-4c04-bfed-2f56a9b14b6e.png" alt="screenshot" title="Optimized Throughput 443/SSL"></p></li></ul> <h4>Review</h4> <p>You should have noticed in one report or another that SSL optimization is working. To prove it you could download the same file again via FTP (open FileZilla connection to n31-fil), or CIFS (map a share to n31-fil), and it should download in just seconds. If by chance the SSL optimization failed, in the next task we will be troubleshooting.</p> <hr> <h3>Task 13. Troubleshoot SSL Connection</h3> <h4>Objective</h4> <p>If your SSL optimization worked in the prior task, Congratulations! You can review this section to prepare yourself for more challenging environments.</p> <p>If your SSL optimization verification in the prior task did <em>not</em> succeed, then this task leverages your knowledge of the SteelHead Web UI, along with the Current Connections Report and System Logs, to diagnose why the SSL optimization isn't working.</p> <p>The key here, as in all troubleshooting, is determining where the problem actually is, and as there are multiple configuration elements, you may need to work through more than one issue. It is suggested to use the Current Connection Report's "Passthrough reason" and the System Log as guides.</p> <h4>Suggested Steps</h4> <ul><li>Diagnose the Current Connections Passthrough reason
<ul><li>"<em>SYN on WAN</em>", for instance, implies the server-side SteelHead did not see a probed SYN; is the client-side SteelHead in-path rule correct?</li> <li>"<em>SSLINNER_FAILURE</em>" indicates a peering trust issue; double-check the Peering Trust table.</li></ul></li> <li>Use the System Logs to diagnose the issue
<ul><li>"<em>SSL handshake between server-side SteelHead appliance and server has failed</em>" implies, well, just that; was the ca.cer certificate installed correctly?</li></ul></li> <li>Verify that your Certificate Authority is properly configured or create a new one.</li> <li>Verify that each SteelHead is in the other's White list in Secure Peering</li> <li>Check whether the server-side SteelHead is bypassing the server, either at the bottom of the <strong>Optimization &gt; SSL &gt; SSL Main Settings</strong> page, or by using the CLI command <code>show protocol ssl backend bypass-table</code></li> <li>Use the Riverbed Support Knowledge Base to search for the error messages</li></ul> <hr> <h3>Task 14. Use a Proxy Certificate for the Server</h3> <h4>Objective</h4> <p>In the real world it is unlikely that you will use the actual private key and certificate for the server itself.  What often occurs is creation of a new  certificate key-pair, signed by a CA trusted in the user environment, and imported as a <em>proxy</em> for the server.  From the point of view of this lab you have completed nearly all of the required steps in task 2, including the essential task of setting up a trusted Certificate Authority, so this task should be pretty straightforward.</p> <h4>Detailed Steps</h4> <ul><li><p>Using the <strong>N130-SH1</strong> Datacenter SteelHead Web UI, navigate to <strong>Optimization &gt; SSL &gt; SSL Main Settings</strong>.</p></li> <li><p>In the <strong>SSL Server Certificates</strong> section, delete the existing server certificate for <code>n31-fil</code>. We will now generate a new proxy certificate and key.</p></li> <li><p>Open <strong>mRemoteNG</strong> and select <strong>Datacenter - Tier 3 - Hosts &gt; n31-fil File Server</strong> in the sidebar.</p> <pre><code>Username:  root
Password:  myeLab!</code></pre></li> <li><p>Type the following command to create a new proxy certificate:</p> <pre><code>openssl req -newkey rsa:2048 -nodes -keyout proxy.key -out proxy.csr</code></pre></li> <li><p>At the resulting prompts enter the details for your proxy certificate:</p> <pre><code>Country Name (2 letter code) [AU]: GB
State or Province Name (full name) [Some-State]: North Yorkshire
Locality Name (eg, city) []: Scarborough
Organization Name (eg, company) [Internet Widgits Pty Ltd]: Proxy Moxy
Organizational Unit Name (eg, section) []: Training Proxy
Common Name (e.g. server FQDN or YOUR name) []: n31-fil.cyberdyne.corp
Email Address []: dave@cyberdyne.corp

A challenge password []: &lt;just press enter&gt;
An optional company name []: &lt;just press enter&gt;</code></pre></li> <li><p>Note how different the details were from the original. This is intentional and we will see why in a later step.  The important part is ensuring that the Common Name, as before, correctly identifies the server in question.  Now we just need to sign it, using our trusted CA, with the following command:</p> <pre><code>openssl x509 -req -days 1095 -in proxy.csr -CA ca.cer -CAkey ca.key -CAcreateserial -out proxy.cer</code></pre></li> <li><p>As this is a later task we can go just a bit deeper.  Let us combine the certificate and key into a single PEM file.  This will make the import to the server-side SteelHead a bit easier.  Type the following command:</p> <pre><code>cat proxy.cer proxy.key &gt; proxy.pem</code></pre></li> <li><p>Using FileZilla copy <em>proxy.pem</em> to your Windows Desktop.</p> <pre><code>Host: 10.99.31.130
Username: root
Password: myeLab!
Port: 22</code></pre></li> <li><p>Using the <strong>N130-SH1</strong> Datacenter SteelHead Web UI, navigate to <strong>Optimization &gt; SSL &gt; SSL Main Settings</strong>.</p></li> <li><p>Under the section <em>SSL Server Certificates</em>, click <strong>Add a New SSL Certificate</strong> and, if desired, name it something useful such as <em>n31-fil</em>.</p></li> <li><p>In the <strong>Certificate</strong> section, leave <strong>Upload</strong> selected and click <strong>Browse</strong>. Navigate to your Desktop and select the <code>proxy.pem</code> file.</p></li> <li><p>Scroll down to the <strong>Private Key</strong> section, and select <code>This file includes the Certificate and Private Key</code>.</p> <p><img src="https://s3.amazonaws.com/edu-screenshots/legacy/114220170120085151.png" alt="screenshot" title="Screenshot"></p></li> <li><p>Scroll down and click <strong>Add</strong>.</p></li> <li><p>The new certificate should appear in the <em>SSL Server Certificates</em> list.  Expand it by clicking the little triangle next to the certificate name.  You should obtain something similar to the following:</p> <p><img src="https://edu-screenshots.s3.amazonaws.com/current/afbb5362-5160-4e58-bfdf-383f1f9667f3.png" alt="screenshot" title="SSL Proxy Cert added"></p> <blockquote><p>Note that a critical part of this is the signing CA must be trusted by the client, or the client will of course not trust the certificate offered by the server-side SteelHead, and the SSL connections to that server would end up in pass-through.</p></blockquote></li> <li><p>Open a new tab in Firefox and navigate to <code>https://n31-fil.cyberdyne.corp</code>.  Click the little gray padlock icon and then click the arrow next to the certificate name.</p> <p><img src="https://edu-screenshots.s3.amazonaws.com/current/af6faa27-6d31-45b7-9f4f-b40d3786f085.png" alt="screenshot" title="Proxy Cert Trusted"></p></li> <li><p>When prompted click <strong>More Information</strong> to obtain the following.</p> <p><img src="https://s3.amazonaws.com/edu-screenshots/legacy/114220170120090226.png" alt="screenshot" title="Screenshot"></p></li> <li><p>Click <strong>View Certificate</strong>.</p> <p><img src="https://edu-screenshots.s3.amazonaws.com/current/aca1c1db-ff96-46a6-96c3-82492f3d5a39.png" alt="screenshot" title="Proxy Cert Details"></p> <blockquote><p>Note that this is NOT the certificate on the server.  During SSL optimization, the Windows client performs a handshake with the server-side SteelHead, not the server itself, so it has been given the proxy certificate rather than the actual one; trusted because the CA that signed the proxy cert has it's CA certificate in the client's trusted Authorities directory.</p></blockquote></li> <li><p>Create some SSL traffic by downloading a file or two from within Firefox. Then navigate to <strong>Reports &gt; Optimization &gt; Optimized Throughput</strong> and ensure that you have selected an appropriate time window.  You should see some throughput scrolling by for Port <em>443 SSL</em>.</p></li></ul> <h4>Review</h4> <p>You have reconfigured SSL to use a signed proxy certificate which is trusted by the clients.</p> <hr> <h3>Extra Credit</h3> <h4>SSL Optimization</h4> <p>After completing the SSL configuration on both SteelHeads and restarting the optimization service, access the secure server from the web browser. These events take place in a successful optimization:</p> <ul><li>In the Web UI, the Current Connections report lists the new connection as optimized without a red protocol error.</li> <li>In the Web UI, the Traffic Summary report displays encrypted traffic (typically, HTTPS).</li> <li>Verify that the back-end server IP appears in the SSL Discovered Server Table (Optimizable) in the SSL Main Settings page.</li></ul> <p><strong>Note:</strong> Because all the SSL handshake operations are processed by the server-side SteelHead, all the SSL statistics are reported on the server-side SteelHead. No SSL statistics are reported on the client-side SteelHead.</p> <h4>Monitoring SSL Connections</h4> <p>Use these tools to verify SSL optimization and to monitor SSL progress:</p> <ul><li>On the client web browser, click the Lock icon to obtain certificate details. The certificate must match the proxy certificate installed on server-side SteelHead.</li> <li>In the Current Connections report, verify the destination IP address, port 443, the Connection Count as Established (three yellow arrows on the left side of the table), SDR Enabled (three cascading yellow squares on the right side of the table), and that there’s no Protocol Error (a red triangle on the left side of the table).</li> <li>In the SSL Statistics report (on the server-side SteelHead only) look for connection requests (established and failed connections), connection establishment rate, and concurrent connections.</li></ul> <h4>Monitoring Secure Inner Channel Connections</h4> <p>Use these tools to verify that secure inner channels are in use for the selected application traffic types:</p> <ul><li>In the Current Connections report, look for the Lock icon and three yellow arrows, which indicate the connection is encrypted and optimized. If the Lock icon is not visible or is dimmed, click the Details icon (gray triangle) to view a failure reason that explains why the SteelHead is not using the secure inner channel to encrypt the connection. If there’s a red protocol error, click the Details icon to view the reason for the error.</li> <li>Search the client-side and server-side SteelHead logs for "<em>SSL</em>" along with ERR and WARN.</li> <li>Whenever using self-signed peering certificates, check that the SteelHeads appear in the <em>Self-Signed Peer White List:</em> on both client-side and server-side SteelHeads.</li></ul> <h4>Certificate Authority Tips &amp; Tricks</h4> <p>We have covered most of these steps during the lab, but it is worth having a number of useful commands set down for reference. There is always more than one way to do the same thing in Linux so some of these commands are slightly different from those in the lab.</p> <p>To Create Certificate Authority (Cert &amp; Key):</p> <pre><code>    openssl genrsa -out CAKeyCyberdyne.key 4096
    openssl req -new -x509 -days 1460 -key CAKeyCyberdyne.key -out CACyberdyne.crt</code></pre> <p>Then create a Certificate signing request on the server (*.csr file). Then back to openSSL to sign it (the *.csr file) with the new Certificate authority that we have just created.</p> <pre><code>    openssl genrsa -des3 -out cyberdyne-n31-fil.key 1024
    openssl req -new -key cyberdyne-n31-fil.key -out cyberdyne-n31-fil.csr
    openssl x509 -req -days 1460 -in cyberdyne-n31-fil.csr -CA CACyberdyne.crt -CAkey CAKeyCyberdyne.key -set_serial 123456 -out cyberdyne-n31-fil.crt</code></pre> <p>Then convert to PKCS12 Format (*.pfx file)</p> <pre><code>    openssl pkcs12 -export -out cyberdyne-n31-fil.pfx -inkey cyberdyne-n31-fil.key -in cyberdyne-n31-fil.crt -certfile CACyberdyne.crt</code></pre> <p>Once you have a new certificate authority created and you've created your keys, you'll need to copy the keys to <code>/etc/ssl/keys</code> and <code>/etc/ssl/private</code> and update the Apache configuration file in <code>/etc/apache2/sites-enabled/default-ssl</code> with the new key paths.</p></div>
